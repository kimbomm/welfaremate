---
description: 복지 상세 재가공 - 크롤링·API 데이터를 WelfareAIData 형식으로 일관되게 재가공할 때 따를 절차
globs: data/welfare-*.json,scripts/crawl-detail/**/*
alwaysApply: false
---

# 복지 상세 재가공 Sub-Agent

사용자가 "상세 재가공", "변경된 항목 재가공", "welfare AI 데이터 만들어줘", "detail rework" 등을 요청할 때 이 룰을 따른다.

## 1. 데이터 소스

- **스냅샷(공공 API)**: `data/welfare-snapshot.json` — `items[].id`, `raw.서비스ID`, `raw.지원내용`, `raw.선정기준`, `raw.지원대상`, `benefit`, `eligibility.conditionsExplained`
- **크롤링 상세**: `data/welfare-detail.json` 또는 `data/welfare-detail-sample.json` — 키는 `서비스ID`, 값은 `documents.required`, `duplicateWarning`, `legalBasis`, `contact`
- **기존 AI 결과**(참조/병합용): `data/welfare-ai-sample.json` — 키는 `welfare_서비스ID`, 값은 WelfareAIData

## 2. 재가공 대상(변경점) 찾기

- **사용자가 ID/목록을 지정한 경우**: 해당 `welfare_서비스ID`만 처리.
- **지정이 없을 때**:
  - `welfare-detail.json`(또는 sample)의 `items` 키(서비스ID) 기준으로, 스냅샷에서 `raw.서비스ID`가 일치하는 항목을 찾는다.
  - 그 중 `welfare-ai-sample.json`에 없거나, 있더라도 **크롤링 갱신 시점**(detail 항목의 `lastCrawled`)이 기존 AI 생성 시점보다 최신인 항목을 "변경된 항목"으로 간주한다.
  - 변경된 항목이 많으면 사용자에게 개수와 샘플 ID를 알리고, 전부 할지 N개만 할지 확인한다.

## 3. 출력 형식 (WelfareAIData)

`data/welfare-ai-sample.json`과 **동일한 구조**. 한 항목당:

```json
{
  "summary": "50자 내외 한글 요약",
  "benefits": [{"label": "항목명", "value": "금액 또는 설명"}],
  "eligibility": {
    "simple": "한 문장 자격 요약",
    "details": ["조건1", "조건2", ...]
  },
  "documents": [{"name": "서류명", "how": "발급처 또는 작성 안내"}],
  "tips": ["팁1", "팁2"],
  "warning": "중복수혜 불가 시에만 문자열, 없으면 null"
}
```

- **summary**: 제목·지원내용·자격을 요약. 50자 내외.
- **benefits**: 스냅샷 `raw.지원내용` 또는 `benefit.description`에서 금액/항목 추출. 최대 5개.
- **eligibility.simple**: 한 문장 요약. **details**: `raw.선정기준`/`raw.지원대상`을 줄 단위(○, \r\n 기준)로 나눈 배열. 최대 5~10개.
- **documents**: 크롤링 `documents.required`를 그대로 사용. 각 항목에 `how`는 발급처 키워드(주민등록→정부24, 소득→홈택스 등) 또는 "신청기관 비치 및 작성".
- **tips**: 홈택스/복지로 등 언급 시 "자세한 내용은 홈택스에서 확인" 등. 최대 3개.
- **warning**: 크롤링 `duplicateWarning`이 있으면 요약해서 넣고, 없으면 `null`.

## 4. 출력 처리

- 재가공한 항목은 **기존 `data/welfare-ai-sample.json`에 병합**한다. 같은 `welfare_서비스ID`가 있으면 덮어쓴다.
- 파일 상단 `version`, `generatedAt`은 병합 시점으로 갱신한다.
- 사용자가 "파일로만 줘"라고 하면, 병합하지 않고 JSON 블록(또는 임시 파일)으로만 전달한다.

## 5. 일관성 유지

- 이 룰을 따르면 IDE에서 누가(어떤 세션에서) 요청해도 같은 데이터 소스·같은 출력 형식·같은 변경점 기준을 사용한다.
- 스크립트 `scripts/crawl-detail/src/ai-reformat.ts`(Gemini 호출)와 출력 형식이 동일하므로, 나중에 스크립트로 다시 돌려도 병합 가능하다.
